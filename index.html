<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LAVMIS Pro | Field Valuation Suite</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        :root { --primary: #1a252f; --accent: #3498db; --success: #27ae60; --warning: #f39c12; --danger: #e74c3c; --text: #ecf0f1; }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; font-family: 'Segoe UI', sans-serif; display: flex; overflow: hidden; background: #111; }
        
        #sidebar { width: 450px; background: var(--primary); color: var(--text); padding: 15px; overflow-y: auto; z-index: 2000; border-right: 2px solid #34495e; box-shadow: 5px 0 20px rgba(0,0,0,0.5); }
        #map { flex-grow: 1; height: 100%; z-index: 1; background: #222; }
        
        .status-container { display: flex; gap: 8px; margin-bottom: 12px; }
        .status-box { flex: 1; padding: 8px; border-radius: 6px; text-align: center; font-size: 0.7rem; font-weight: bold; background: #2c3e50; border: 1px solid #3e5871; text-transform: uppercase; }
        .good { color: var(--success); border-color: var(--success); }
        .bad { color: var(--danger); border-color: var(--danger); }
        .warn { color: var(--warning); border-color: var(--warning); }

        .panel { background: #2c3e50; border-radius: 8px; padding: 12px; margin-bottom: 12px; border-top: 3px solid var(--accent); position: relative; }
        
        .locked-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 100; border-radius: 8px; color: white; font-weight: bold; text-align: center; font-size: 0.85rem; padding: 10px; box-sizing: border-box; transition: 0.3s; pointer-events: none; opacity: 0; }
        .panel.locked .locked-overlay { opacity: 1; pointer-events: all; }

        input, select, textarea { width: 100%; padding: 10px; margin: 4px 0; border-radius: 4px; border: 1px solid #34495e; background: #1a252f; color: white; box-sizing: border-box; font-size: 0.9rem; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        
        button { cursor: pointer; font-weight: bold; border: none; padding: 12px; border-radius: 4px; width: 100%; margin-top: 5px; transition: 0.2s; }
        .btn-success { background: var(--success); color: white; }
        .btn-nav { background: #8e44ad; color: white; font-size: 0.75rem; }
        .btn-manual { background: #5d6d7e; color: white; font-size: 0.7rem; }

        .data-log { background: #161d24; border-radius: 6px; max-height: 250px; overflow-y: auto; margin-top: 10px; border: 1px solid #2c3e50; }
        .log-item { padding: 10px 12px; border-bottom: 1px solid #2c3e50; font-size: 0.8rem; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .log-item:hover { background: #1c2833; }
        .log-item b { color: var(--warning); }

        @media (max-width: 768px) { body { flex-direction: column; } #sidebar { width: 100%; height: 65%; } #map { height: 35%; } }
    </style>
</head>
<body>

<div id="sidebar">
    <h2 style="margin:0 0 10px 0; color:var(--warning); letter-spacing: 1px;">LAVMIS PRO</h2>
    
    <div class="status-container">
        <div id="gps-status" class="status-box bad">GPS: NO FIX</div>
        <div id="net-status" class="status-box bad">OFFLINE</div>
    </div>

    <div class="panel">
        <div class="grid-2">
            <button id="followBtn" onclick="toggleFollow()" class="btn-nav"><i class="fa-solid fa-person-walking"></i> FOLLOW: ON</button>
            <button onclick="seedSatellite()" style="background:var(--warning); color:#000; font-size:0.7rem;">CACHE MAP</button>
        </div>
        <div id="cache-info" style="font-size: 0.6rem; color: var(--success); text-align: center; margin-top: 5px; display: none;">Caching tiles... <span id="p-val">0</span>%</div>
    </div>

    <div id="capturePanel" class="panel locked">
        <div class="locked-overlay" id="lockMsg">WAITING FOR STABLE GPS<br>(3m - 15m)</div>
        
        <input type="text" id="propId" placeholder="Property ID / Name">
        <div class="grid-2">
            <input type="text" id="blk" placeholder="Block No.">
            <input type="text" id="plt" placeholder="Plot No.">
        </div>
        <select id="landUse">
            <option value="Residential">Residential</option>
            <option value="Commercial">Commercial</option>
            <option value="Agricultural">Agricultural</option>
            <option value="Industrial">Industrial</option>
        </select>
        <textarea id="desc" rows="2" placeholder="Property Description..."></textarea>
        <div class="grid-2">
            <input type="number" id="price" placeholder="Price ($)">
            <input type="number" id="size" placeholder="Size (Ha)">
        </div>
        <input type="file" id="photo" accept="image/*" capture="environment">
        <button onclick="saveRecord()" class="btn-success"><i class="fa-solid fa-floppy-disk"></i> SAVE & CLEAR</button>
    </div>

    <div class="panel">
        <button onclick="enableManualMode()" class="btn-manual"><i class="fa-solid fa-hand-pointer"></i> MANUAL PICK (GPS BACKUP)</button>
        <div id="manual-coords" style="font-size:0.65rem; color:#7f8c8d; margin-top:5px; text-align:center;">Using Real-time GPS</div>
    </div>

    <div style="font-size: 0.75rem; color: var(--accent); font-weight: bold; margin-bottom: 5px;">PROPERTY LOG</div>
    <div class="data-log" id="dataLog"></div>
    <button onclick="exportExcel()" style="background:#27ae60; color:white; margin-top:15px;"><i class="fa-solid fa-file-excel"></i> EXPORT TO EXCEL</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/pouchdb@8.0.1/dist/pouchdb.min.js"></script>
<script src="https://unpkg.com/leaflet.tilelayer.pouchdbcached@1.0.0/L.TileLayer.PouchDBCached.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

<script>
    // 1. PWA REGISTRATION
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');

    const map = L.map('map', { zoomControl: false, maxZoom: 18 }).setView([0,0], 2);
    const savedLayer = L.featureGroup().addTo(map);
    const liveLayer = L.layerGroup().addTo(map);

    const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        useCache: true, crossOrigin: true, cacheMaxAge: 1209600000 
    }).addTo(map);

    // 2. APP STATE
    let currentPos = null;
    let manualPos = null;
    let isManualMode = false;
    let isFollowing = true;
    let isFirstFix = true;

    // 3. GPS ACCURACY ENGINE
    navigator.geolocation.watchPosition(pos => {
        currentPos = pos;
        const { latitude, longitude, accuracy } = pos.coords;
        const gpsStatus = document.getElementById('gps-status');
        const capturePanel = document.getElementById('capturePanel');
        
        gpsStatus.innerText = `GPS: ${accuracy.toFixed(1)}m`;

        if (isFirstFix && accuracy <= 25) {
            map.flyTo([latitude, longitude], 17);
            isFirstFix = false;
        } else if (isFollowing) {
            map.panTo([latitude, longitude]);
        }

        // UNLOCK GATE: Validates accuracy
        if (isManualMode || (accuracy <= 15)) {
            gpsStatus.className = "status-box good";
            capturePanel.classList.remove('locked');
        } else {
            gpsStatus.className = "status-box warn";
            capturePanel.classList.add('locked');
            document.getElementById('lockMsg').innerHTML = `ACCURACY POOR (${accuracy.toFixed(0)}m)<br>WAIT FOR BETTER SIGNAL`;
        }

        liveLayer.clearLayers();
        L.circleMarker([latitude, longitude], {
            radius: 8, color: '#fff', fillColor: '#3498db', fillOpacity: 1, weight: 3
        }).addTo(liveLayer);

    }, err => console.warn(err), { enableHighAccuracy: true, maximumAge: 1000 });

    // 4. MAP NAVIGATION
    function toggleFollow() {
        isFollowing = !isFollowing;
        const btn = document.getElementById('followBtn');
        btn.innerHTML = isFollowing ? '<i class="fa-solid fa-person-walking"></i> FOLLOW: ON' : '<i class="fa-solid fa-hand"></i> FOLLOW: OFF';
        btn.style.background = isFollowing ? "#8e44ad" : "#34495e";
    }

    map.on('movestart', (e) => { if (!e.hard && isFollowing) toggleFollow(); });

    function seedSatellite() {
        if (map.getZoom() < 15) return alert("Zoom into the property site (Z15+) first.");
        document.getElementById('cache-info').style.display = 'block';
        satellite.seed(map.getBounds(), map.getZoom(), map.getZoom() + 1);
    }
    satellite.on('seedprogress', e => document.getElementById('p-val').innerText = Math.floor((e.downloaded/e.remaining)*100));
    satellite.on('seedend', () => { alert("Offline map cached!"); document.getElementById('cache-info').style.display = 'none'; });

    function enableManualMode() {
        isManualMode = true;
        document.getElementById('capturePanel').classList.remove('locked');
        document.getElementById('manual-coords').innerText = "TAP MAP TO SET POINT";
        document.getElementById('manual-coords').style.color = "var(--warning)";
        map.getContainer().style.cursor = "crosshair";
    }

    map.on('click', e => {
        if (!isManualMode) return;
        manualPos = e.latlng;
        document.getElementById('manual-coords').innerText = `Set: ${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`;
        map.getContainer().style.cursor = "";
    });

    // 5. DATA MANAGEMENT & FORM RESET
    async function saveRecord() {
        const lat = manualPos ? manualPos.lat : currentPos.coords.latitude;
        const lng = manualPos ? manualPos.lng : currentPos.coords.longitude;
        
        const photoFile = document.getElementById('photo').files[0];
        let photoData = "";
        if (photoFile) {
            photoData = await new Promise(r => {
                const reader = new FileReader();
                reader.onload = () => r(reader.result);
                reader.readAsDataURL(photoFile);
            });
        }

        const price = document.getElementById('price').value;
        const size = document.getElementById('size').value;

        const record = {
            uid: Date.now(),
            pId: document.getElementById('propId').value || "Unnamed",
            block: document.getElementById('blk').value,
            plot: document.getElementById('plt').value,
            use: document.getElementById('landUse').value,
            desc: document.getElementById('desc').value,
            price: price,
            size: size,
            rate: (price / size).toFixed(2),
            lat: lat.toFixed(6), lng: lng.toFixed(6),
            acc: manualPos ? "Manual" : currentPos.coords.accuracy.toFixed(1) + "m",
            time: new Date().toLocaleString()
        };

        const db = JSON.parse(localStorage.getItem('lavmis_db') || '[]');
        db.push(record);
        localStorage.setItem('lavmis_db', JSON.stringify(db));
        
        // --- CLEAR FORM LOGIC ---
        ['propId', 'blk', 'plt', 'desc', 'price', 'size', 'photo'].forEach(id => {
            document.getElementById(id).value = "";
        });
        document.getElementById('landUse').selectedIndex = 0;
        
        // Reset Manual Mode
        isManualMode = false; manualPos = null;
        document.getElementById('manual-coords').innerText = "Using Real-time GPS";
        document.getElementById('manual-coords').style.color = "";
        
        refreshUI();
        alert("Property Saved & Logged!");
    }

    function refreshUI() {
        const log = document.getElementById('dataLog');
        log.innerHTML = "";
        savedLayer.clearLayers();
        const db = JSON.parse(localStorage.getItem('lavmis_db') || '[]');

        db.forEach(item => {
            L.marker([item.lat, item.lng]).addTo(savedLayer)
                .bindPopup(`
                    <div style="min-width:200px">
                        <b>${item.pId}</b><hr>
                        Blk/Plt: ${item.block}/${item.plot}<br>
                        Rate: $${item.rate}/Ha<br>
                        ${item.photo ? `<img src="${item.photo}" style="width:100%; margin-top:8px; border-radius:4px;">` : ''}
                    </div>
                `);

            const div = document.createElement('div');
            div.className = 'log-item';
            div.innerHTML = `<span><b>${item.pId}</b><br><small>${item.time}</small></span><i class="fa-solid fa-check-circle" style="color:var(--success)"></i>`;
            div.onclick = () => { isFollowing = false; map.flyTo([item.lat, item.lng], 18); };
            log.appendChild(div);
        });
    }

    function exportExcel() {
        const data = JSON.parse(localStorage.getItem('lavmis_db') || '[]');
        if (data.length === 0) return alert("Nothing to export.");
        const clean = data.map(({photo, uid, ...rest}) => rest);
        const ws = XLSX.utils.json_to_sheet(clean);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "ValuationAudit");
        XLSX.writeFile(wb, `LAVMIS_Export_${Date.now()}.xlsx`);
    }

    window.addEventListener('online',  () => { document.getElementById('net-status').innerText = "ONLINE"; document.getElementById('net-status').className = "status-box good"; });
    window.addEventListener('offline', () => { document.getElementById('net-status').innerText = "OFFLINE"; document.getElementById('net-status').className = "status-box warn"; });
    
    window.onload = refreshUI;
</script>
</body>
</html>
