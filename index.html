<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LAVMIS Data Collector Module</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <style>
        :root { --sidebar-width: 420px; --primary: #1a252f; --accent: #3498db; --success: #27ae60; --warning: #f1c40f; --danger: #e74c3c; --valuation: #f39c12; --panel-bg: #2c3e50; }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; font-family: 'Segoe UI', sans-serif; overflow: hidden; display: flex; }
        #sidebar { width: var(--sidebar-width); background: var(--primary); color: white; padding: 15px; overflow-y: auto; z-index: 2000; box-shadow: 4px 0 15px rgba(0,0,0,0.3); }
        #map { flex-grow: 1; height: 100%; z-index: 1; background: #222; }
        
        @media (max-width: 768px) {
            body { flex-direction: column; }
            #sidebar { width: 100%; height: 55%; order: 2; border-top: 3px solid var(--accent); }
            #map { height: 45%; order: 1; }
        }

        .panel { background: var(--panel-bg); border-radius: 8px; padding: 12px; margin-bottom: 12px; border-top: 4px solid var(--accent); }
        .mode-tabs { display: flex; gap: 4px; margin-bottom: 10px; background: #1a252f; padding: 4px; border-radius: 8px; }
        .tab-btn { padding: 8px; font-size: 0.75rem; background: transparent; border: none; flex: 1; color: #bdc3c7; cursor: pointer; transition: 0.2s; }
        .tab-btn.active { background: var(--valuation); color: #1a252f; border-radius: 6px; font-weight: bold; }

        .accuracy-pill { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-radius: 6px; margin-bottom: 10px; font-weight: bold; }
        .acc-red { background: rgba(231, 76, 60, 0.2); color: #ff7675; border: 1px solid var(--danger); }
        .acc-yellow { background: rgba(241, 196, 15, 0.2); color: var(--warning); border: 1px solid var(--warning); }
        .acc-green { background: rgba(39, 174, 96, 0.2); color: #55efc4; border: 1px solid var(--success); }
        
        input, select, textarea, button { width: 100%; padding: 10px; margin-bottom: 8px; border-radius: 6px; border: none; font-size: 0.9rem; box-sizing: border-box; }
        label { font-size: 0.75rem; color: #bdc3c7; margin-bottom: 4px; display: block; }
        button { background: var(--accent); color: white; font-weight: 600; cursor: pointer; }
        
        .table-container { background: #1a252f; border-radius: 6px; overflow-x: auto; max-height: 120px; font-size: 0.75rem; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #2c3e50; }

        .coord-box { background: #f0f0f0; padding: 5px; border-radius: 4px; border: 1px solid #ccc; margin: 8px 0; font-family: monospace; font-size: 11px; color: #444; }
        .doc-link { color: var(--accent); text-decoration: none; font-weight: bold; display: block; margin-top: 5px; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2 style="text-align:center; color: var(--valuation);"><i class="fa-solid fa-database"></i> LAVMIS MODULE</h2>
    
    <div class="panel">
        <h3>1. Location Method</h3>
        <div class="mode-tabs">
            <button class="tab-btn active" id="tab-live" onclick="setMode('live')">Live GPS</button>
            <button class="tab-btn" id="tab-map" onclick="setMode('map')">Map Pin</button>
            <button class="tab-btn" id="tab-coords" onclick="setMode('coords')">Manual</button>
        </div>
        <div id="live-panel">
            <div id="accDisplay" class="accuracy-pill acc-red">
                <span>Signal Accuracy:</span><span id="acc-val">Searching...</span>
            </div>
        </div>
        <div id="coord-panel" style="display: none; flex-direction: column;">
            <div style="display: flex; gap: 5px;">
                <input type="number" id="manual-lat" placeholder="Latitude" step="any">
                <input type="number" id="manual-lng" placeholder="Longitude" step="any">
            </div>
            <button onclick="setManualCoords()" style="background: var(--valuation); color: #1a252f;">Plot Point</button>
        </div>
    </div>

    <div class="panel">
        <h3>2. Audit Details</h3>
        <div style="display: flex; gap: 5px;">
            <input type="number" id="price" placeholder="Total Price ($)">
            <input type="number" id="size" placeholder="Area Size (Ha)">
        </div>
        <select id="landUse">
            <option value="Residential">Residential</option>
            <option value="Commercial">Commercial</option>
            <option value="Agricultural">Agricultural</option>
            <option value="Industrial">Industrial</option>
        </select>
        <textarea id="description" placeholder="Property Description (Optional)" rows="2"></textarea>
        <label>Sales Agreement (Optional)</label>
        <input type="file" id="agreementFile">
        
        <button id="submitBtn" onclick="saveEntry()" style="background: var(--success);" disabled>
            <i class="fa-solid fa-save"></i> Save Entry
        </button>
    </div>

    <div class="panel">
        <div class="table-container">
            <table id="valTable">
                <thead><tr><th>Use</th><th>Rate/Ha</th><th>Preview</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <button onclick="exportData()" style="margin-top:10px; background:#27ae60;">
            <i class="fa-solid fa-file-excel"></i> Export Excel (Incl. Coordinates)
        </button>
    </div>
</div>

<div id="map"></div>



<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

<script>
    const map = L.map('map', { zoomControl: false }).setView([0,0], 2);
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}').addTo(map);
    
    const activeLayer = L.layerGroup().addTo(map);
    const savedLayer = L.featureGroup().addTo(map);
    
    let currentMarker = null;
    let currentMode = 'live';
    let watchId = null;

    function setMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`tab-${mode}`).classList.add('active');
        document.getElementById('live-panel').style.display = mode === 'live' ? 'block' : 'none';
        document.getElementById('coord-panel').style.display = mode === 'coords' ? 'flex' : 'none';
        if (mode === 'live') triggerAutoGPS();
        else {
            if (watchId) navigator.geolocation.clearWatch(watchId);
            document.getElementById('submitBtn').disabled = false;
        }
    }

    function triggerAutoGPS() {
        if (watchId) navigator.geolocation.clearWatch(watchId);
        watchId = navigator.geolocation.watchPosition((pos) => {
            if (currentMode !== 'live') return;
            updateUI([pos.coords.latitude, pos.coords.longitude], pos.coords.accuracy);
        }, (err) => console.error(err), { enableHighAccuracy: true });
    }

    function updateUI(latlng, accuracy) {
        document.getElementById('acc-val').innerText = accuracy.toFixed(1) + "m";
        const accDisplay = document.getElementById('accDisplay');
        const submitBtn = document.getElementById('submitBtn');
        accDisplay.className = "accuracy-pill " + (accuracy <= 3 ? "acc-green" : (accuracy <= 15 ? "acc-yellow" : "acc-red"));
        submitBtn.disabled = accuracy > 15;
        updateActiveMarker(latlng);
        map.setView(latlng, 18);
    }

    function setManualCoords() {
        const lat = parseFloat(document.getElementById('manual-lat').value);
        const lng = parseFloat(document.getElementById('manual-lng').value);
        if (!isNaN(lat) && !isNaN(lng)) {
            updateActiveMarker([lat, lng]);
            map.setView([lat, lng], 17);
        }
    }

    map.on('click', (e) => { if (currentMode === 'map') updateActiveMarker(e.latlng); });

    function updateActiveMarker(latlng) {
        activeLayer.clearLayers();
        currentMarker = L.circleMarker(latlng, { radius: 12, color: '#fff', fillColor: '#3498db', fillOpacity: 0.8, weight: 3 }).addTo(activeLayer);
    }

    function saveEntry() {
        const p = document.getElementById('price').value;
        const s = document.getElementById('size').value;
        const u = document.getElementById('landUse').value;
        const desc = document.getElementById('description').value || "N/A";
        const fileInput = document.getElementById('agreementFile');
        const fileName = fileInput.files[0] ? fileInput.files[0].name : "None";
        const fileUrl = fileInput.files[0] ? URL.createObjectURL(fileInput.files[0]) : null;

        if (!p || !s || !currentMarker) return alert("Incomplete data.");

        const coords = currentMarker.getLatLng();
        const rate = (p / s).toFixed(0);

        const entry = {
            Date: new Date().toLocaleDateString(),
            LandUse: u,
            Total_Price: p,
            Area_Ha: s,
            Rate_Per_Ha: rate,
            Latitude: coords.lat.toFixed(6),
            Longitude: coords.lng.toFixed(6),
            Description: desc,
            Attached_Doc: fileName,
            internalBlob: fileUrl // Hidden from excel export
        };

        const marker = L.marker([entry.Latitude, entry.Longitude]).addTo(savedLayer);
        marker.bindPopup(`
            <div style="min-width:180px">
                <b style="color:var(--valuation)">${u.toUpperCase()}</b><br>
                <b>Total:</b> $${Number(p).toLocaleString()}<br>
                <b>Size:</b> ${s} Ha<br>
                <b>Rate:</b> $${Number(rate).toLocaleString()}/Ha<br>
                <div class="coord-box">${entry.Latitude}, ${entry.Longitude}</div>
                ${fileUrl ? `<a href="${fileUrl}" target="_blank" class="doc-link">View Document</a>` : ''}
            </div>
        `);

        let data = JSON.parse(localStorage.getItem('lavmis_db') || '[]');
        data.push(entry);
        localStorage.setItem('lavmis_db', JSON.stringify(data));
        loadTable();
        
        document.getElementById('price').value = "";
        document.getElementById('size').value = "";
        document.getElementById('description').value = "";
        document.getElementById('agreementFile').value = "";
    }

    function loadTable() {
        const tbody = document.querySelector("#valTable tbody");
        tbody.innerHTML = "";
        let data = JSON.parse(localStorage.getItem('lavmis_db') || '[]');
        data.reverse().forEach(item => {
            const row = tbody.insertRow();
            row.innerHTML = `<td>${item.LandUse}</td><td>$${Number(item.Rate_Per_Ha).toLocaleString()}</td><td><button onclick="map.setView([${item.Latitude}, ${item.Longitude}], 18)">Find</button></td>`;
        });
    }

    function exportData() {
        let data = JSON.parse(localStorage.getItem('lavmis_db') || '[]');
        if (data.length === 0) return alert("No data.");
        
        // Remove internal properties before Excel generation
        const cleanData = data.map(({internalBlob, ...rest}) => rest);
        
        const ws = XLSX.utils.json_to_sheet(cleanData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "LAVMIS Export");
        XLSX.writeFile(wb, "LAVMIS_Field_Audit_With_Coordinates.xlsx");
    }

    window.onload = () => { triggerAutoGPS(); loadTable(); };
</script>
</body>
</html>
